<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gitforge Copilot - Interface Professionnelle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar { scrollbar-width: thin; scrollbar-color: #d1d5db transparent; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        [x-cloak] { display: none !important; }
        
        .sidebar-transition {
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        /* Style pour la carte des modèles */
        .model-card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        /* Style pour les fichiers importés */
        .file-item {
            transition: all 0.2s ease;
        }
        
        .file-item:hover {
            background-color: #f9fafb;
        }
        
        /* Animation pour l'apparition de la carte d'importation */
        .import-card-enter {
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
        }
        
        .import-card-enter-active {
            opacity: 1;
            transform: translateY(0) scale(1);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        
        .import-card-leave {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        
        .import-card-leave-active {
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        
        /* Style pour le drag-and-drop */
        .drag-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        
        .drag-overlay {
            background-color: rgba(59, 130, 246, 0.1);
            border: 2px dashed #3b82f6;
        }
        
        /* Animation pour les nouveaux messages */
        .message-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        
        .message-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        /* Style pour les messages utilisateur - PLUS CLAIR */
        .user-message-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.05);
            position: relative;
            max-width: 90%;
            margin-left: auto;
        }
        
        .user-message-card::before {
            content: '';
            position: absolute;
            right: -8px;
            top: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid #e2e8f0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }
        
        .user-message-card::after {
            content: '';
            position: absolute;
            right: -7px;
            top: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid #f8fafc;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }
        
        .message-collapsed {
            max-height: 120px;
            overflow: hidden;
            position: relative;
        }
        
        .message-expanded {
            max-height: none;
        }
        
        .message-gradient {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(to bottom, transparent, #f9fafb);
        }
        
        .message-expanded .message-gradient {
            display: none;
        }
        
        /* Style pour les cartes de fichiers */
        .file-preview-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            min-width: 180px;
            max-width: 200px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .file-preview-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: #3b82f6;
        }
        
        .files-container {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
            margin-bottom: 16px;
        }
        
        /* Style pour la zone de saisie focus */
        .chat-input-focused {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Style pour le menu de gestion de discussion */
        .chat-management-menu {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            min-width: 200px;
            z-index: 60;
        }
        
        /* Style pour les longs messages avec gestion des tokens */
        .token-counter {
            font-size: 11px;
            padding: 2px 8px;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .message-content-wrapper {
            position: relative;
            padding-right: 20px;
        }
        
        .copy-message-btn {
            position: absolute;
            right: 0;
            top: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .user-message-card:hover .copy-message-btn {
            opacity: 1;
        }
        
        /* Styles pour le markdown */
        .markdown-content h1 {
            font-size: 1.875rem;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.75rem;
            color: #111827;
        }
        
        .markdown-content h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: #111827;
        }
        
        .markdown-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
            color: #111827;
        }
        
        .markdown-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .markdown-content li {
            margin-bottom: 0.25rem;
        }
        
        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875em;
        }
        
        .markdown-content pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #d1d5db;
            padding-left: 1rem;
            margin-left: 0;
            margin-bottom: 1rem;
            color: #6b7280;
            font-style: italic;
        }
        
        /* Styles pour la carte de partage */
        .share-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15), 0 10px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            min-width: 320px;
            max-width: 400px;
        }
        
        /* Styles pour la carte de profil */
        .profile-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            min-width: 260px;
            max-width: 320px;
        }
        
        /* Transition pour les cartes */
        .card-enter {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
        }
        
        .card-enter-active {
            opacity: 1;
            transform: scale(1) translateY(0);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        
        .card-leave {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        
        .card-leave-active {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
            transition: opacity 0.15s ease, transform 0.15s ease;
        }
        
        /* Style pour les discussions dans la sidebar */
        .chat-item {
            position: relative;
            padding-left: 0.75rem;
        }
        
        .chat-item-menu {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .chat-item:hover .chat-item-menu {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-white h-screen flex overflow-hidden" x-data="{ 
    sidebarOpen: false, 
    modelMenuOpen: false, 
    selectedModel: 'Claude Haiku 4.5',
    importMenuOpen: false,
    importedFiles: [],
    chatInputHeight: 'auto',
    messages: [
        { 
            type: 'user', 
            content: 'Quelles sont les caractéristiques d\'une interface professionnelle et que faut-il respecter pour la barre de défilement ?',
            expanded: true,
            needsExpansion: false,
            tokens: 42,
            files: []
        },
        { 
            type: 'assistant', 
            content: '# Caractéristiques d\'une interface professionnelle\n\nCréer une interface professionnelle nécessite une attention particulière aux **détails visuels**, à l\'**expérience utilisateur (UX)** et à l\'**ergonomie**. Voici les points essentiels :\n\n## Caractéristiques clés :\n\n- **Design épuré** : Utilisation d\'espaces blancs pour laisser respirer le contenu et réduire la charge cognitive.\n- **Barre de défilement (Scrollbar)** : Elle ne doit pas être la barre standard du navigateur. Elle doit être fine, discrète (souvent grise claire) et ne s\'afficher ou s\'assombrir qu\'au survol pour ne pas distraire l\'utilisateur.\n- **Navigation contextuelle** : Les menus doivent être accessibles là où l\'utilisateur en a besoin, sans encombrer l\'écran.\n- **Typographie** : Utilisation de polices sans-serif modernes avec une hiérarchie claire (tailles de texte différenciées).\n\n## Exemple de code CSS pour une scrollbar personnalisée :\n\n```css\n.custom-scrollbar::-webkit-scrollbar {\n    width: 6px;\n}\n\n.custom-scrollbar::-webkit-scrollbar-track {\n    background: transparent;\n}\n\n.custom-scrollbar::-webkit-scrollbar-thumb {\n    background: #d1d5db;\n    border-radius: 10px;\n}\n```',
            expanded: true,
            needsExpansion: false 
        }
    ],
    isDragging: false,
    newChatMode: false,
    dragCounter: 0,
    chatManagementOpen: false,
    chatInputFocused: false,
    currentChatTitle: 'Comparaison entre Gitforge Copilot et Git...',
    chatManagementPosition: { x: 0, y: 0 },
    shareMenuOpen: false,
    shareUrl: 'https://gitforge.com/copilot/chat/abc123',
    shareVisibility: 'private',
    profileMenuOpen: false,
    theme: 'light',
    activeChatMenu: null,
    mobileSidebarControls: true
}" x-init="chatInputHeight = 'auto'; setupDragAndDrop();" @keydown.ctrl.enter="sendMessage" @keydown.cmd.enter="sendMessage" @resize.window="handleResize()">

    <aside 
        x-cloak
        :class="sidebarOpen ? 'w-64 translate-x-0' : 'w-0 -translate-x-full lg:translate-x-[-100%]'" 
        class="sidebar-transition border-r border-gray-100 flex flex-col bg-white h-full z-40 fixed lg:relative overflow-hidden"
    >
        <div class="p-4 mb-4 min-w-[256px] flex items-center justify-between">
            <img src="https://i.postimg.cc/t4NCGNzD/gitforge-png.png" alt="Gitforge Logo" class="h-8 w-auto">
            
            <!-- Bouton de fermeture visible uniquement sur mobile quand la sidebar est ouverte -->
            <button x-show="sidebarOpen && mobileSidebarControls" @click="sidebarOpen = false" 
                    class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 lg:hidden">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>

        <nav class="flex-1 px-3 space-y-1 overflow-y-auto custom-scrollbar min-w-[256px]">
            <button @click="startNewChat" class="w-full flex items-center gap-3 px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-lg text-[15px] transition-colors">
                <span class="material-symbols-rounded text-[22px]">edit_square</span> New chat
            </button>
            <button class="w-full flex items-center gap-3 px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-lg text-[15px] transition-colors">
                <span class="material-symbols-rounded text-[22px]">smart_toy</span> Agents
            </button>
            <button class="w-full flex items-center gap-3 px-3 py-2 text-gray-700 hover:bg-gray-50 rounded-lg text-[15px] transition-colors">
                <span class="material-symbols-rounded text-[22px]">folder</span> Spaces
            </button>

            <div class="mt-8 pt-4">
                <p class="px-3 text-[12px] font-semibold text-gray-400 uppercase tracking-wider mb-2">Last 7 days</p>
                <div class="space-y-1">
                    <div class="chat-item px-3 py-2 text-[15px] text-gray-600 hover:bg-gray-50 rounded-lg cursor-pointer truncate">
                        <div class="flex items-center justify-between">
                            <span>Comparaison entre Gitforge...</span>
                            <button @click.stop="activeChatMenu = activeChatMenu === 1 ? null : 1" 
                                    class="chat-item-menu p-1 hover:bg-gray-200 rounded">
                                <span class="material-symbols-rounded text-gray-500">more_vert</span>
                            </button>
                        </div>
                        
                        <!-- Menu pour cette discussion -->
                        <div x-show="activeChatMenu === 1" @click.outside="activeChatMenu = null"
                             class="absolute left-0 right-0 mt-1 z-50 chat-management-menu">
                            <div class="p-2">
                                <button @click="renameChat" class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded-lg text-[14px] text-gray-700 transition-colors">
                                    <span class="material-symbols-rounded text-[20px] text-gray-500">edit</span>
                                    Rename
                                </button>
                                <button @click="pinChat" class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded-lg text-[14px] text-gray-700 transition-colors">
                                    <span class="material-symbols-rounded text-[20px] text-gray-500">push_pin</span>
                                    Pin chat
                                </button>
                                <div class="h-px bg-gray-100 my-1"></div>
                                <button @click="deleteChat" class="w-full flex items-center gap-3 px-3 py-2 hover:bg-red-50 rounded-lg text-[14px] text-red-600 transition-colors">
                                    <span class="material-symbols-rounded text-[20px]">delete</span>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-item px-3 py-2 text-[15px] text-gray-600 hover:bg-gray-50 rounded-lg cursor-pointer truncate">
                        <div class="flex items-center justify-between">
                            <span>Optimisation React</span>
                            <button @click.stop="activeChatMenu = activeChatMenu === 2 ? null : 2" 
                                    class="chat-item-menu p-1 hover:bg-gray-200 rounded">
                                <span class="material-symbols-rounded text-gray-500">more_vert</span>
                            </button>
                        </div>
                        
                        <!-- Menu pour cette discussion -->
                        <div x-show="activeChatMenu === 2" @click.outside="activeChatMenu = null"
                             class="absolute left-0 right-0 mt-1 z-50 chat-management-menu">
                            <div class="p-2">
                                <button @click="renameChat" class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded-lg text-[14px] text-gray-700 transition-colors">
                                    <span class="material-symbols-rounded text-[20px] text-gray-500">edit</span>
                                    Rename
                                </button>
                                <button @click="pinChat" class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded-lg text-[14px] text-gray-700 transition-colors">
                                    <span class="material-symbols-rounded text-[20px] text-gray-500">push_pin</span>
                                    Pin chat
                                </button>
                                <div class="h-px bg-gray-100 my-1"></div>
                                <button @click="deleteChat" class="w-full flex items-center gap-3 px-3 py-2 hover:bg-red-50 rounded-lg text-[14px] text-red-600 transition-colors">
                                    <span class="material-symbols-rounded text-[20px]">delete</span>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Section stable en bas de la sidebar -->
        <div class="mt-auto border-t border-gray-50 min-w-[256px]">
            <div class="p-3 space-y-1">
                <button @click="sidebarOpen = false" class="w-full flex items-center gap-3 px-3 py-2 text-gray-500 hover:bg-gray-50 rounded-lg text-sm">
                    <span class="material-symbols-rounded">dock_to_left</span> Collapse
                </button>
                
                <!-- Profil utilisateur -->
                <div class="relative">
                    <button @click="profileMenuOpen = !profileMenuOpen" 
                            class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded-lg transition-colors">
                        <div class="w-9 h-9 rounded-full bg-yellow-100 flex items-center justify-center text-sm font-bold text-yellow-700 border border-yellow-200">
                            M
                        </div>
                        <div class="flex flex-col flex-1 text-left">
                            <span class="text-sm font-medium text-gray-700">mindus0</span>
                            <span class="text-[11px] text-gray-400">Copilot Free</span>
                        </div>
                        <span class="material-symbols-rounded text-gray-400 text-sm" 
                              :class="profileMenuOpen ? 'rotate-180' : ''">expand_more</span>
                    </button>
                    
                    <!-- Menu profil -->
                    <div x-show="profileMenuOpen" @click.outside="profileMenuOpen = false"
                         x-transition:enter="card-enter"
                         x-transition:enter-start="card-enter"
                         x-transition:enter-end="card-enter-active"
                         x-transition:leave="card-leave"
                         x-transition:leave-start="card-leave"
                         x-transition:leave-end="card-leave-active"
                         class="absolute bottom-full left-0 mb-2 w-full profile-card z-50"
                         x-cloak>
                        <div class="p-3">
                            <div class="mb-3">
                                <p class="text-sm font-medium text-gray-700">mindus0</p>
                                <p class="text-xs text-gray-500">Copilot Free</p>
                            </div>
                            
                            <div class="space-y-1">
                                <button class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded-lg text-sm text-gray-700 transition-colors">
                                    <span class="material-symbols-rounded text-[20px] text-gray-500">settings</span>
                                    Settings
                                </button>
                                
                                <button class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded-lg text-sm text-gray-700 transition-colors">
                                    <span class="material-symbols-rounded text-[20px] text-gray-500">upgrade</span>
                                    Upgrade plan
                                </button>
                                
                                <!-- Sélecteur de thème -->
                                <div class="px-3 py-2">
                                    <p class="text-xs font-medium text-gray-500 mb-2">Theme</p>
                                    <div class="flex items-center gap-2">
                                        <button @click="theme = 'light'" 
                                                class="flex items-center gap-1.5 px-2 py-1 rounded text-xs"
                                                :class="theme === 'light' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-100 text-gray-600'">
                                            <span class="material-symbols-rounded text-sm">light_mode</span>
                                            Light
                                        </button>
                                        <button @click="theme = 'dark'" 
                                                class="flex items-center gap-1.5 px-2 py-1 rounded text-xs"
                                                :class="theme === 'dark' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-100 text-gray-600'">
                                            <span class="material-symbols-rounded text-sm">dark_mode</span>
                                            Dark
                                        </button>
                                        <button @click="theme = 'system'" 
                                                class="flex items-center gap-1.5 px-2 py-1 rounded text-xs"
                                                :class="theme === 'system' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-100 text-gray-600'">
                                            <span class="material-symbols-rounded text-sm">computer</span>
                                            System
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="h-px bg-gray-100 my-1"></div>
                                
                                <button @click="clearAllHistory" 
                                        class="w-full flex items-center gap-3 px-3 py-2 hover:bg-red-50 rounded-lg text-sm text-red-600 transition-colors">
                                    <span class="material-symbols-rounded text-[20px]">delete_forever</span>
                                    Clear all history
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative h-full min-w-0 bg-white">
        
        <header class="h-16 flex items-center justify-between px-4 md:px-6 border-b border-gray-50 bg-white shrink-0">
            <div class="flex items-center gap-3 overflow-hidden">
                <!-- Bouton menu - caché sur mobile quand sidebar ouverte -->
                <button x-show="!sidebarOpen || !mobileSidebarControls" 
                        @click="sidebarOpen = !sidebarOpen" 
                        class="p-2 hover:bg-gray-100 rounded-lg text-gray-500 lg:hidden">
                    <span class="material-symbols-rounded">menu</span>
                </button>
                
                <!-- Bouton nouvelle discussion - caché sur mobile quand sidebar ouverte -->
                <button x-show="!sidebarOpen || !mobileSidebarControls" 
                        @click="startNewChat" 
                        class="p-2 hover:bg-gray-100 rounded-lg text-gray-500" 
                        title="Nouvelle discussion">
                    <span class="material-symbols-rounded">edit_square</span>
                </button>
                
                <div class="relative">
                    <button 
                        @click="chatManagementOpen = !chatManagementOpen; updateChatMenuPosition($event)"
                        class="flex items-center gap-2 cursor-pointer group truncate" 
                        :class="newChatMode ? 'text-gray-500' : 'text-gray-800'">
                        <span class="font-semibold text-[15px] truncate max-w-[200px]" x-text="newChatMode ? 'Nouvelle discussion' : currentChatTitle"></span>
                        <span class="material-symbols-rounded text-gray-400 text-sm group-hover:rotate-180 transition-transform">arrow_drop_down</span>
                    </button>
                    
                    <!-- Menu de gestion de discussion -->
                    <div 
                        x-show="chatManagementOpen && !newChatMode" 
                        @click.outside="chatManagementOpen = false"
                        :style="`left: ${chatManagementPosition.x}px; top: ${chatManagementPosition.y}px`"
                        class="fixed sm:absolute sm:left-0 sm:top-full sm:mt-2 z-50 chat-management-menu"
                        x-cloak
                        x-transition:enter="transition ease-out duration-200"
                        x-transition:enter-start="opacity-0 scale-95"
                        x-transition:enter-end="opacity-100 scale-100"
                    >
                        <div class="p-2">
                            <button @click="renameChat" class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded-lg text-[14px] text-gray-700 transition-colors">
                                <span class="material-symbols-rounded text-[20px] text-gray-500">edit</span>
                                Rename
                            </button>
                            <button @click="pinChat" class="w-full flex items-center gap-3 px-3 py-2 hover:bg-gray-50 rounded-lg text-[14px] text-gray-700 transition-colors">
                                <span class="material-symbols-rounded text-[20px] text-gray-500">push_pin</span>
                                Pin chat
                            </button>
                            <div class="h-px bg-gray-100 my-1"></div>
                            <button @click="deleteChat" class="w-full flex items-center gap-3 px-3 py-2 hover:bg-red-50 rounded-lg text-[14px] text-red-600 transition-colors">
                                <span class="material-symbols-rounded text-[20px]">delete</span>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="relative">
                    <button @click="shareMenuOpen = !shareMenuOpen" 
                            class="flex items-center gap-2 border border-gray-200 px-3 py-1.5 rounded-lg text-[13px] font-medium hover:bg-gray-50">
                        <span class="material-symbols-rounded text-sm">share</span> Share
                    </button>
                    
                    <!-- Carte de partage -->
                    <div x-show="shareMenuOpen" @click.outside="shareMenuOpen = false"
                         x-transition:enter="card-enter"
                         x-transition:enter-start="card-enter"
                         x-transition:enter-end="card-enter-active"
                         x-transition:leave="card-leave"
                         x-transition:leave-start="card-leave"
                         x-transition:leave-end="card-leave-active"
                         class="absolute right-0 top-full mt-2 share-card z-50"
                         x-cloak>
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-gray-900">Share chat</h3>
                                <button @click="shareMenuOpen = false" class="p-1 hover:bg-gray-100 rounded">
                                    <span class="material-symbols-rounded text-gray-500">close</span>
                                </button>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Visibility</label>
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" x-model="shareVisibility" value="private" class="text-blue-600">
                                        <span class="text-sm text-gray-700">Private</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" x-model="shareVisibility" value="public" class="text-blue-600">
                                        <span class="text-sm text-gray-700">Public</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Link</label>
                                <div class="flex items-center gap-2">
                                    <input type="text" x-model="shareUrl" readonly 
                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm bg-gray-50">
                                    <button @click="copyShareUrl" 
                                            class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                                        Copy
                                    </button>
                                </div>
                            </div>
                            
                            <p class="text-xs text-gray-500">
                                <span x-show="shareVisibility === 'private'">
                                    Only people with the link can access this chat.
                                </span>
                                <span x-show="shareVisibility === 'public'">
                                    Anyone with the link can access this chat.
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Overlay pour le drag-and-drop -->
        <div x-show="isDragging" @dragover.prevent @drop.prevent="handleDrop" @dragleave="handleDragLeave"
             class="fixed inset-0 z-50 bg-white/90 flex items-center justify-center pointer-events-auto"
             x-cloak>
            <div class="drag-overlay rounded-2xl w-full max-w-2xl mx-4 h-64 flex flex-col items-center justify-center">
                <span class="material-symbols-rounded text-6xl text-blue-500 mb-4">upload</span>
                <p class="text-xl font-medium text-gray-700">Déposez vos fichiers ici</p>
                <p class="text-gray-500 mt-2">Images, documents, fichiers de code...</p>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar" id="chatContainer">
            <div class="max-w-3xl mx-auto py-10 px-4 space-y-10">
                <!-- Messages existants -->
                <template x-for="(message, index) in messages" :key="index">
                    <div x-data="{ isVisible: false }" x-init="setTimeout(() => isVisible = true, 50)" 
                         :class="isVisible ? 'message-enter-active' : 'message-enter'"
                         class="flex gap-4" :class="message.type === 'user' ? 'flex-col items-end' : ''">
                        <template x-if="message.type === 'user'">
                            <div class="user-message-card px-6 py-4 text-gray-800 text-[16px] leading-relaxed w-full"
                                 :class="message.needsExpansion && !message.expanded ? 'message-collapsed' : 'message-expanded'">
                                <div class="message-content-wrapper">
                                    <p x-text="message.content"></p>
                                    <button @click="copyMessage(index)" class="copy-message-btn p-1 hover:bg-white/50 rounded-lg" title="Copier le message">
                                        <span class="material-symbols-rounded text-gray-500 text-sm">content_copy</span>
                                    </button>
                                </div>
                                
                                <!-- Affichage des fichiers si présents -->
                                <template x-if="message.files && message.files.length > 0">
                                    <div class="files-container">
                                        <template x-for="(file, fileIndex) in message.files" :key="fileIndex">
                                            <div class="file-preview-card">
                                                <div class="flex items-start gap-2">
                                                    <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center shrink-0">
                                                        <template x-if="file.type === 'code'">
                                                            <span class="material-symbols-rounded text-gray-600">code</span>
                                                        </template>
                                                        <template x-if="file.type === 'document'">
                                                            <span class="material-symbols-rounded text-gray-600">description</span>
                                                        </template>
                                                        <template x-if="file.type === 'image'">
                                                            <span class="material-symbols-rounded text-gray-600">image</span>
                                                        </template>
                                                        <template x-if="file.type === 'repository'">
                                                            <span class="material-symbols-rounded text-gray-600">folder</span>
                                                        </template>
                                                        <template x-if="file.type === 'archive'">
                                                            <span class="material-symbols-rounded text-gray-600">folder_zip</span>
                                                        </template>
                                                    </div>
                                                    <div class="flex-1 min-w-0">
                                                        <div class="text-[13px] font-medium text-gray-800 truncate" x-text="file.name"></div>
                                                        <div class="text-[11px] text-gray-500" x-text="file.size"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                
                                <!-- Compteur de tokens et bouton d'expansion -->
                                <div class="flex items-center justify-between mt-3">
                                    <div class="flex items-center gap-3">
                                        <template x-if="message.tokens">
                                            <div class="token-counter">
                                                <span class="material-symbols-rounded text-xs">memory</span>
                                                <span x-text="message.tokens"></span> tokens
                                            </div>
                                        </template>
                                        <template x-if="message.files && message.files.length > 0">
                                            <div class="token-counter">
                                                <span class="material-symbols-rounded text-xs">attach_file</span>
                                                <span x-text="message.files.length"></span> fichiers
                                            </div>
                                        </template>
                                    </div>
                                    
                                    <template x-if="message.needsExpansion">
                                        <button @click="toggleMessageExpand(index)" 
                                                class="mt-2 flex items-center gap-1 text-[13px] text-blue-600 hover:text-blue-800 font-medium">
                                            <span x-text="message.expanded ? 'Voir moins' : 'Voir plus'"></span>
                                            <span class="material-symbols-rounded text-sm transition-transform" 
                                                  :class="message.expanded ? 'rotate-180' : ''">expand_more</span>
                                        </button>
                                    </template>
                                </div>
                                
                                <template x-if="message.needsExpansion && !message.expanded">
                                    <div class="message-gradient"></div>
                                </template>
                            </div>
                        </template>
                        <template x-if="message.type === 'assistant'">
                            <div class="flex gap-4 w-full">
                                <div class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center shrink-0 border border-gray-200">
                                    <span class="material-symbols-rounded text-gray-400 text-2xl">smart_toy</span>
                                </div>
                                <div class="flex-1 space-y-6 text-gray-800 leading-relaxed text-[16px]" 
                                     :class="message.needsExpansion && !message.expanded ? 'message-collapsed' : 'message-expanded'">
                                    <div class="relative markdown-content">
                                        <div x-html="convertMarkdown(message.content)"></div>
                                    </div>
                                    
                                    <template x-if="message.needsExpansion">
                                        <button @click="toggleMessageExpand(index)" 
                                                class="flex items-center gap-1 text-[13px] text-gray-500 hover:text-gray-700 font-medium">
                                            <span x-text="message.expanded ? 'Voir moins' : 'Voir plus'"></span>
                                            <span class="material-symbols-rounded text-sm transition-transform" 
                                                  :class="message.expanded ? 'rotate-180' : ''">expand_more</span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>

        <footer class="p-4 md:p-6 bg-white shrink-0">
            <div class="max-w-3xl mx-auto relative">
                
                <!-- Carte de sélection de modèle (existante) -->
                <div 
                    x-show="modelMenuOpen" 
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                    @click.outside="modelMenuOpen = false"
                    class="fixed inset-0 z-50 flex items-center justify-center sm:absolute sm:inset-auto sm:bottom-full sm:right-0 sm:mb-4 w-full sm:w-[320px] p-4 sm:p-0"
                    x-cloak
                >
                    <div class="bg-white w-full rounded-2xl model-card overflow-hidden flex flex-col max-h-[90vh]">
                        <div class="flex items-center justify-between p-4 border-b border-gray-100 sm:hidden">
                            <span class="font-bold">Select Model</span>
                            <button @click="modelMenuOpen = false" class="p-1">
                                <span class="material-symbols-rounded">close</span>
                            </button>
                        </div>

                        <div class="overflow-y-auto custom-scrollbar p-2">
                            <div class="px-3 py-2 text-[11px] font-bold text-gray-400 uppercase">Fast and cost-efficient</div>
                            <button @click="selectedModel = 'GPT-5 mini'; modelMenuOpen = false" class="w-full flex items-center justify-between px-3 py-2.5 hover:bg-gray-50 rounded-xl transition-colors">
                                <div class="flex items-center gap-3">
                                    <div class="w-6 h-6 bg-gray-100 rounded flex items-center justify-center text-[10px] font-bold">G5</div>
                                    <span class="text-[14px] text-gray-700">GPT-5 mini</span>
                                </div>
                            </button>

                            <div class="h-[1px] bg-gray-50 my-2"></div>

                            <div class="px-3 py-2 text-[11px] font-bold text-gray-400 uppercase">Versatile and highly intelligent</div>
                            <button @click="selectedModel = 'Claude Haiku 4.5'; modelMenuOpen = false" class="w-full flex items-center justify-between px-3 py-2.5 bg-gray-50 rounded-xl transition-colors">
                                <div class="flex items-center gap-3">
                                    <div class="w-6 h-6 bg-orange-100 text-orange-600 rounded flex items-center justify-center text-[10px] font-bold">A</div>
                                    <span class="text-[14px] font-medium text-gray-900">Claude Haiku 4.5</span>
                                </div>
                                <span class="material-symbols-rounded text-blue-500 text-sm">check</span>
                            </button>
                            
                            <button @click="selectedModel = 'GPT-4o'; modelMenuOpen = false" class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-gray-50 rounded-xl transition-colors">
                                <div class="w-6 h-6 bg-green-100 text-green-600 rounded flex items-center justify-center text-[10px] font-bold">O</div>
                                <span class="text-[14px] text-gray-700">GPT-4o</span>
                            </button>

                            <div class="h-[1px] bg-gray-50 my-2"></div>

                            <div class="px-3 py-2 text-[11px] font-bold text-gray-400 uppercase">Most powerful at complex tasks</div>
                            <button @click="selectedModel = 'Claude Opus 4.1'; modelMenuOpen = false" class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-gray-50 rounded-xl transition-colors">
                                <div class="w-6 h-6 bg-purple-100 text-purple-600 rounded flex items-center justify-center text-[10px] font-bold">Op</div>
                                <span class="text-[14px] text-gray-700">Claude Opus 4.1</span>
                            </button>
                            <button @click="selectedModel = 'Gemini 2.5 Pro'; modelMenuOpen = false" class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-gray-50 rounded-xl transition-colors">
                                <div class="w-6 h-6 bg-blue-100 text-blue-600 rounded flex items-center justify-center text-[10px] font-bold">G</div>
                                <span class="text-[14px] text-gray-700">Gemini 2.5 Pro</span>
                            </button>
                        </div>
                        
                        <div class="p-3 bg-gray-50 border-t border-gray-100">
                            <button class="text-[12px] text-blue-600 font-medium hover:underline">Upgrade to access more models</button>
                        </div>
                    </div>
                </div>
                
                <!-- Carte d'importation (nouvelle) -->
                <div 
                    x-show="importMenuOpen" 
                    x-transition:enter="import-card-enter"
                    x-transition:enter-start="import-card-enter"
                    x-transition:enter-end="import-card-enter-active"
                    x-transition:leave="import-card-leave"
                    x-transition:leave-start="import-card-leave"
                    x-transition:leave-end="import-card-leave-active"
                    @click.outside="importMenuOpen = false"
                    class="absolute bottom-full left-0 mb-3 z-40 w-80 bg-white rounded-2xl model-card overflow-hidden"
                    x-cloak
                >
                    <div class="p-4 border-b border-gray-100">
                        <h3 class="font-bold text-gray-900">Importer des fichiers</h3>
                        <p class="text-[13px] text-gray-500 mt-1">Ajoutez des fichiers ou des dépôts pour les utiliser dans votre conversation</p>
                    </div>
                    
                    <div class="p-2">
                        <!-- Bouton pour importer depuis l'ordinateur -->
                        <button @click="addFileFromComputer" class="w-full flex items-center gap-3 px-3 py-3 hover:bg-gray-50 rounded-xl transition-colors text-left">
                            <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-rounded">upload</span>
                            </div>
                            <div class="flex-1">
                                <span class="text-[14px] font-medium text-gray-900">Depuis votre ordinateur</span>
                                <p class="text-[12px] text-gray-500">Importer des fichiers depuis votre PC</p>
                            </div>
                        </button>
                        
                        <button @click="addRepository" class="w-full flex items-center gap-3 px-3 py-3 hover:bg-gray-50 rounded-xl transition-colors text-left">
                            <div class="w-10 h-10 bg-green-100 text-green-600 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-rounded">folder</span>
                            </div>
                            <div class="flex-1">
                                <span class="text-[14px] font-medium text-gray-900">Depuis un dépôt Git</span>
                                <p class="text-[12px] text-gray-500">Connecter un dépôt GitHub, GitLab, etc.</p>
                            </div>
                        </button>
                        
                        <button @click="addSpace" class="w-full flex items-center gap-3 px-3 py-3 hover:bg-gray-50 rounded-xl transition-colors text-left">
                            <div class="w-10 h-10 bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center">
                                <span class="material-symbols-rounded">dataset</span>
                            </div>
                            <div class="flex-1">
                                <span class="text-[14px] font-medium text-gray-900">Depuis un espace</span>
                                <p class="text-[12px] text-gray-500">Sélectionner des fichiers depuis vos espaces</p>
                            </div>
                        </button>
                    </div>
                    
                    <div class="p-3 bg-gray-50 border-t border-gray-100">
                        <p class="text-[12px] text-gray-500">Les fichiers sont ajoutés à la conversation actuelle</p>
                    </div>
                </div>

                <!-- Zone de saisie principale avec affichage des fichiers importés -->
                <div id="chatInputContainer" 
                     class="border border-gray-200 rounded-2xl focus-within:border-gray-300 transition-all duration-200 shadow-sm bg-white overflow-hidden" 
                     :class="isDragging ? 'drag-active' : (chatInputFocused ? 'chat-input-focused' : '')"
                     :style="{ maxHeight: chatInputHeight === 'auto' ? 'none' : '400px' }"
                     @dragover.prevent="handleDragOver" @dragleave="handleContainerDragLeave" @drop.prevent="handleDrop">
                    
                    <!-- Section pour afficher les fichiers importés (avec limite de 10) -->
                    <div x-show="importedFiles.length > 0" class="border-b border-gray-100">
                        <div class="px-4 pt-3 pb-2 flex items-center justify-between">
                            <h4 class="text-[13px] font-medium text-gray-700">
                                Fichiers à envoyer <span x-text="'(' + importedFiles.length + '/10)'"></span>
                            </h4>
                            <button @click="clearAllFiles" class="text-[11px] text-gray-500 hover:text-gray-700">Tout effacer</button>
                        </div>
                        
                        <div class="px-3 pb-3">
                            <div class="files-container">
                                <template x-for="(file, index) in importedFiles.slice(0, 10)" :key="index">
                                    <div class="file-preview-card">
                                        <div class="flex items-start gap-2">
                                            <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center shrink-0">
                                                <template x-if="file.type === 'code'">
                                                    <span class="material-symbols-rounded text-gray-600">code</span>
                                                </template>
                                                <template x-if="file.type === 'document'">
                                                    <span class="material-symbols-rounded text-gray-600">description</span>
                                                </template>
                                                <template x-if="file.type === 'image'">
                                                    <span class="material-symbols-rounded text-gray-600">image</span>
                                                </template>
                                                <template x-if="file.type === 'repository'">
                                                    <span class="material-symbols-rounded text-gray-600">folder</span>
                                                </template>
                                                <template x-if="file.type === 'archive'">
                                                    <span class="material-symbols-rounded text-gray-600">folder_zip</span>
                                                </template>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-[13px] font-medium text-gray-800 truncate" x-text="file.name"></div>
                                                <div class="text-[11px] text-gray-500" x-text="file.size"></div>
                                            </div>
                                            <button @click="removeFile(index)" class="p-1 hover:bg-gray-100 rounded" title="Supprimer">
                                                <span class="material-symbols-rounded text-gray-400 text-sm">close</span>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                                
                                <!-- Message si plus de 10 fichiers -->
                                <div x-show="importedFiles.length > 10" class="text-sm text-amber-600 italic">
                                    + <span x-text="importedFiles.length - 10"></span> fichier(s) supplémentaire(s)
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zone de texte -->
                    <div class="relative">
                        <textarea 
                            id="chatInput"
                            class="w-full p-4 pr-16 bg-transparent outline-none text-[16px] resize-none overflow-y-auto custom-scrollbar" 
                            placeholder="Ask anything"
                            rows="1"
                            style="max-height: 200px;"
                            @input="adjustTextareaHeight"
                            @focus="chatInputFocused = true; importMenuOpen = false; modelMenuOpen = false;"
                            @blur="chatInputFocused = false"></textarea>
                        
                        <!-- Indicateur de caractères -->
                        <div class="absolute right-4 bottom-16">
                            <div x-show="estimateTokens() > 0" class="token-counter">
                                <span x-text="estimateTokens()"></span> tokens estimés
                            </div>
                        </div>
                    </div>
                    
                    <!-- Barre d'outils -->
                    <div class="flex items-center justify-between px-4 pb-3">
                        <div class="flex items-center gap-4 text-gray-400">
                            <div class="relative">
                                <button 
                                    @click="importMenuOpen = !importMenuOpen"
                                    class="flex items-center gap-1.5 hover:text-gray-600 text-[14px] transition-colors"
                                    :class="importMenuOpen ? 'text-blue-600' : ''"
                                >
                                    <span class="material-symbols-rounded text-xl">add</span>
                                    <span class="hidden sm:inline">Add files...</span>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div 
                                @click="modelMenuOpen = !modelMenuOpen"
                                class="flex items-center gap-1 text-[13px] text-gray-600 font-medium bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded-lg cursor-pointer transition-colors"
                                :class="modelMenuOpen ? 'bg-gray-200' : ''"
                            >
                                <span x-text="selectedModel">Claude Haiku 4.5</span> 
                                <span class="material-symbols-rounded text-sm" :class="modelMenuOpen ? 'rotate-180' : ''">expand_more</span>
                            </div>
                            <button @click="sendMessage" 
                                    class="text-gray-300 transition-colors" 
                                    :class="(document.getElementById('chatInput').value.trim() || importedFiles.length > 0) ? 'text-blue-500 hover:text-blue-600' : ''">
                                <span class="material-symbols-rounded text-[28px]">send</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </footer>

    </main>

    <div x-show="sidebarOpen" @click="sidebarOpen = false" class="fixed inset-0 bg-black/20 z-30 lg:hidden" x-transition.opacity x-cloak></div>

    <script>
        // Fonction pour convertir le markdown en HTML
        function convertMarkdown(text) {
            if (!text) return '';
            
            let html = text;
            
            // Titres
            html = html.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1>$1</h1>');
            
            // Gras
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // Italique
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/_(.*?)_/g, '<em>$1</em>');
            
            // Listes non ordonnées
            html = html.replace(/^\s*\*\s+(.*$)/gm, '<li>$1</li>');
            html = html.replace(/^\s*-\s+(.*$)/gm, '<li>$1</li>');
            
            // Bloquer les listes
            const lines = html.split('\n');
            let inList = false;
            let newHtml = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (line.startsWith('<li>')) {
                    if (!inList) {
                        newHtml += '<ul>\n';
                        inList = true;
                    }
                    newHtml += line + '\n';
                } else {
                    if (inList) {
                        newHtml += '</ul>\n';
                        inList = false;
                    }
                    newHtml += line + '\n';
                }
            }
            
            if (inList) {
                newHtml += '</ul>\n';
            }
            
            html = newHtml;
            
            // Code inline
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Blocs de code
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, function(match, lang, code) {
                return '<pre><code class="language-' + (lang || 'plaintext') + '">' + 
                       escapeHtml(code) + '</code></pre>';
            });
            
            // Liens
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-blue-600 hover:underline">$1</a>');
            
            // Paragraphes
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/^\s*(<\/?[^>]+>)?\s*$/gm, '$1');
            
            // Ajouter la balise <p> initiale si nécessaire
            if (!html.startsWith('<') || html.startsWith('<p>')) {
                html = '<p>' + html;
            }
            
            if (!html.endsWith('</p>')) {
                html += '</p>';
            }
            
            return html;
        }
        
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
        
        // Fonctions pour gérer l'importation de fichiers
        function addFileFromComputer() {
            // Vérifier la limite de fichiers
            if (Alpine.$data(document.body).importedFiles.length >= 10) {
                alert('Vous ne pouvez importer que 10 fichiers maximum.');
                Alpine.$data(document.body).importMenuOpen = false;
                return;
            }
            
            // Simuler un clic sur un input file caché
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            
            fileInput.addEventListener('change', function(e) {
                const files = e.target.files;
                handleFileUpload(files);
                document.body.removeChild(fileInput);
            });
            
            fileInput.click();
        }
        
        function addRepository() {
            // Vérifier la limite de fichiers
            if (Alpine.$data(document.body).importedFiles.length >= 10) {
                alert('Vous ne pouvez importer que 10 fichiers maximum.');
                Alpine.$data(document.body).importMenuOpen = false;
                return;
            }
            
            // Simuler l'ajout d'un dépôt
            Alpine.$data(document.body).importedFiles.push({
                name: 'mon-depot-git',
                size: 'Dépôt Git',
                type: 'repository'
            });
            
            Alpine.$data(document.body).importMenuOpen = false;
            Alpine.$data(document.body).adjustTextareaHeight();
            
            alert("Dans une implémentation complète, cela ouvrirait une connexion à l'API pour sélectionner un dépôt Git.");
        }
        
        function addSpace() {
            // Vérifier la limite de fichiers
            if (Alpine.$data(document.body).importedFiles.length >= 10) {
                alert('Vous ne pouvez importer que 10 fichiers maximum.');
                Alpine.$data(document.body).importMenuOpen = false;
                return;
            }
            
            // Simuler l'ajout d'un espace
            Alpine.$data(document.body).importedFiles.push({
                name: 'Espace de travail principal',
                size: 'Espace Gitforge',
                type: 'document'
            });
            
            Alpine.$data(document.body).importMenuOpen = false;
            Alpine.$data(document.body).adjustTextareaHeight();
            
            alert("Dans une implémentation complète, cela ouvrirait une sélection d'espace avec les fichiers disponibles.");
        }
        
        function removeFile(index) {
            Alpine.$data(document.body).importedFiles.splice(index, 1);
            Alpine.$data(document.body).adjustTextareaHeight();
        }
        
        function clearAllFiles() {
            Alpine.$data(document.body).importedFiles = [];
            Alpine.$data(document.body).adjustTextareaHeight();
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Estimer le nombre de tokens
        function estimateTokens() {
            const textarea = document.getElementById('chatInput');
            const text = textarea.value.trim();
            
            if (!text) return 0;
            
            const tokens = Math.ceil(text.length / 4);
            return tokens;
        }
        
        // Ajuster la hauteur de la zone de texte
        function adjustTextareaHeight() {
            const textarea = document.getElementById('chatInput');
            const fileCount = Alpine.$data(document.body).importedFiles.length;
            
            textarea.style.height = 'auto';
            const scrollHeight = textarea.scrollHeight;
            const maxHeight = 200;
            let newHeight = Math.min(scrollHeight, maxHeight);
            
            if (fileCount > 0) {
                Alpine.$data(document.body).chatInputHeight = '400px';
            } else {
                Alpine.$data(document.body).chatInputHeight = 'auto';
            }
            
            textarea.style.height = newHeight + 'px';
        }
        
        // Fonction pour envoyer un message
        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message && Alpine.$data(document.body).importedFiles.length === 0) {
                return;
            }
            
            let messageContent = '';
            let needsExpansion = false;
            const tokens = estimateTokens();
            
            if (message) {
                messageContent = message;
                needsExpansion = message.length > 500;
            }
            
            const filesToSend = [...Alpine.$data(document.body).importedFiles];
            
            Alpine.$data(document.body).messages.push({
                type: 'user',
                content: messageContent,
                expanded: !needsExpansion,
                needsExpansion: needsExpansion,
                tokens: tokens,
                files: filesToSend
            });
            
            setTimeout(() => {
                let assistantResponse = 'J\'ai bien reçu votre message' + (message ? ' : "' + message.substring(0, 100) + (message.length > 100 ? '...' : '') + '"' : '') + 
                        (filesToSend.length > 0 ? ' ainsi que vos ' + filesToSend.length + ' fichier(s).' : '.') + 
                        '\n\n## Comment puis-je vous aider ?\n\nJe suis prêt à vous assister avec :\n- L\'analyse de vos fichiers\n- Des explications détaillées\n- Des suggestions d\'amélioration\n- La génération de code\n\nN\'hésitez pas à me poser des questions spécifiques !';
                
                let assistantNeedsExpansion = assistantResponse.length > 500;
                
                Alpine.$data(document.body).messages.push({
                    type: 'assistant',
                    content: assistantResponse,
                    expanded: !assistantNeedsExpansion,
                    needsExpansion: assistantNeedsExpansion
                });
                
                scrollToNewMessage();
            }, 1000);
            
            chatInput.value = '';
            Alpine.$data(document.body).importedFiles = [];
            adjustTextareaHeight();
            
            Alpine.$data(document.body).importMenuOpen = false;
            Alpine.$data(document.body).modelMenuOpen = false;
            
            if (Alpine.$data(document.body).newChatMode) {
                Alpine.$data(document.body).newChatMode = false;
                if (message) {
                    const shortMessage = message.substring(0, 40) + (message.length > 40 ? '...' : '');
                    Alpine.$data(document.body).currentChatTitle = shortMessage;
                }
            }
            
            setTimeout(scrollToNewMessage, 50);
        }
        
        // Basculer l'expansion d'un message
        function toggleMessageExpand(index) {
            Alpine.$data(document.body).messages[index].expanded = !Alpine.$data(document.body).messages[index].expanded;
        }
        
        // Copier un message
        function copyMessage(index) {
            const message = Alpine.$data(document.body).messages[index];
            const textToCopy = message.content.replace(/<br>/g, '\n').replace(/<[^>]*>/g, '');
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                const copyBtn = event.target.closest('.copy-message-btn');
                const originalHtml = copyBtn.innerHTML;
                copyBtn.innerHTML = '<span class="material-symbols-rounded text-green-500 text-sm">check</span>';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHtml;
                }, 2000);
            });
        }
        
        // Copier l'URL de partage
        function copyShareUrl() {
            navigator.clipboard.writeText(Alpine.$data(document.body).shareUrl).then(() => {
                alert('URL copiée dans le presse-papiers !');
                Alpine.$data(document.body).shareMenuOpen = false;
            });
        }
        
        // Effacer tout l'historique
        function clearAllHistory() {
            if (confirm('Êtes-vous sûr de vouloir supprimer tout votre historique de discussions ? Cette action est irréversible.')) {
                alert('Historique supprimé avec succès !');
                Alpine.$data(document.body).profileMenuOpen = false;
            }
        }
        
        // Gérer le redimensionnement de la fenêtre
        function handleResize() {
            const isMobile = window.innerWidth < 1024;
            Alpine.$data(document.body).mobileSidebarControls = isMobile;
        }
        
        // Faire défiler pour voir le dernier message
        function scrollToNewMessage() {
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
        
        // Configuration du drag-and-drop
        function setupDragAndDrop() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
        }
        
        // Gérer le drag over
        function handleDragOver(e) {
            Alpine.$data(document.body).dragCounter++;
            Alpine.$data(document.body).isDragging = true;
        }
        
        // Gérer le drag leave du conteneur
        function handleContainerDragLeave(e) {
            if (!e.currentTarget.contains(e.relatedTarget)) {
                Alpine.$data(document.body).dragCounter--;
                if (Alpine.$data(document.body).dragCounter <= 0) {
                    Alpine.$data(document.body).isDragging = false;
                    Alpine.$data(document.body).dragCounter = 0;
                }
            }
        }
        
        // Gérer le drag leave de l'overlay
        function handleDragLeave(e) {
            Alpine.$data(document.body).dragCounter--;
            if (Alpine.$data(document.body).dragCounter <= 0) {
                Alpine.$data(document.body).isDragging = false;
                Alpine.$data(document.body).dragCounter = 0;
            }
        }
        
        // Gérer le drop de fichiers
        function handleDrop(e) {
            Alpine.$data(document.body).isDragging = false;
            Alpine.$data(document.body).dragCounter = 0;
            
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFileUpload(files);
            }
        }
        
        // Traiter l'upload de fichiers avec limite de 10
        function handleFileUpload(files) {
            const currentCount = Alpine.$data(document.body).importedFiles.length;
            const remainingSlots = 10 - currentCount;
            
            if (files.length > remainingSlots) {
                alert(`Vous ne pouvez ajouter que ${remainingSlots} fichier(s) supplémentaire(s). La limite est de 10 fichiers.`);
                files = Array.from(files).slice(0, remainingSlots);
            }
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                let fileType = 'document';
                
                if (file.name.match(/\.(js|ts|java|cpp|py|rb|php|html|css|json|xml|yml|yaml)$/i)) {
                    fileType = 'code';
                } else if (file.name.match(/\.(jpg|jpeg|png|gif|svg|bmp|webp)$/i)) {
                    fileType = 'image';
                } else if (file.name.match(/\.(zip|rar|tar|gz|7z)$/i)) {
                    fileType = 'archive';
                }
                
                Alpine.$data(document.body).importedFiles.push({
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: fileType
                });
            }
            
            Alpine.$data(document.body).adjustTextareaHeight();
        }
        
        // Démarrer une nouvelle discussion
        function startNewChat() {
            Alpine.$data(document.body).messages = [];
            Alpine.$data(document.body).importedFiles = [];
            Alpine.$data(document.body).newChatMode = true;
            Alpine.$data(document.body).currentChatTitle = 'Nouvelle discussion';
            
            const chatInput = document.getElementById('chatInput');
            chatInput.value = '';
            adjustTextareaHeight();
            
            Alpine.$data(document.body).importMenuOpen = false;
            Alpine.$data(document.body).modelMenuOpen = false;
            Alpine.$data(document.body).chatManagementOpen = false;
            
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.scrollTop = 0;
            }
        }
        
        // Mettre à jour la position du menu de gestion
        function updateChatMenuPosition(event) {
            const rect = event.target.getBoundingClientRect();
            Alpine.$data(document.body).chatManagementPosition = {
                x: rect.left,
                y: rect.bottom + window.scrollY
            };
        }
        
        // Renommer la discussion
        function renameChat() {
            const newTitle = prompt('Renommer la discussion:', Alpine.$data(document.body).currentChatTitle);
            if (newTitle && newTitle.trim()) {
                Alpine.$data(document.body).currentChatTitle = newTitle.trim();
            }
            Alpine.$data(document.body).chatManagementOpen = false;
        }
        
        // Épingler la discussion
        function pinChat() {
            alert('Discussion épinglée! (Fonctionnalité à implémenter)');
            Alpine.$data(document.body).chatManagementOpen = false;
        }
        
        // Supprimer la discussion
        function deleteChat() {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette discussion ?')) {
                Alpine.$data(document.body).messages = [];
                Alpine.$data(document.body).importedFiles = [];
                Alpine.$data(document.body).currentChatTitle = 'Nouvelle discussion';
                Alpine.$data(document.body).newChatMode = true;
                
                const chatInput = document.getElementById('chatInput');
                chatInput.value = '';
                adjustTextareaHeight();
                
                alert('Discussion supprimée avec succès!');
            }
            Alpine.$data(document.body).chatManagementOpen = false;
        }
        
        // Initialiser les fonctions dans le contexte Alpine
        document.addEventListener('alpine:init', () => {
            Alpine.data('appData', () => ({
                sidebarOpen: false,
                modelMenuOpen: false,
                selectedModel: 'Claude Haiku 4.5',
                importMenuOpen: false,
                importedFiles: [],
                chatInputHeight: 'auto',
                messages: [
                    { 
                        type: 'user', 
                        content: 'Quelles sont les caractéristiques d\'une interface professionnelle et que faut-il respecter pour la barre de défilement ?',
                        expanded: true,
                        needsExpansion: false,
                        tokens: 42,
                        files: []
                    },
                    { 
                        type: 'assistant', 
                        content: '# Caractéristiques d\'une interface professionnelle\n\nCréer une interface professionnelle nécessite une attention particulière aux **détails visuels**, à l\'**expérience utilisateur (UX)** et à l\'**ergonomie**. Voici les points essentiels :\n\n## Caractéristiques clés :\n\n- **Design épuré** : Utilisation d\'espaces blancs pour laisser respirer le contenu et réduire la charge cognitive.\n- **Barre de défilement (Scrollbar)** : Elle ne doit pas être la barre standard du navigateur. Elle doit être fine, discrète (souvent grise claire) et ne s\'afficher ou s\'assombrir qu\'au survol pour ne pas distraire l\'utilisateur.\n- **Navigation contextuelle** : Les menus doivent être accessibles là où l\'utilisateur en a besoin, sans encombrer l\'écran.\n- **Typographie** : Utilisation de polices sans-serif modernes avec une hiérarchie claire (tailles de texte différenciées).\n\n## Exemple de code CSS pour une scrollbar personnalisée :\n\n```css\n.custom-scrollbar::-webkit-scrollbar {\n    width: 6px;\n}\n\n.custom-scrollbar::-webkit-scrollbar-track {\n    background: transparent;\n}\n\n.custom-scrollbar::-webkit-scrollbar-thumb {\n    background: #d1d5db;\n    border-radius: 10px;\n}\n```',
                        expanded: true,
                        needsExpansion: false 
                    }
                ],
                isDragging: false,
                newChatMode: false,
                dragCounter: 0,
                chatManagementOpen: false,
                chatInputFocused: false,
                currentChatTitle: 'Comparaison entre Gitforge Copilot et Git...',
                chatManagementPosition: { x: 0, y: 0 },
                shareMenuOpen: false,
                shareUrl: 'https://gitforge.com/copilot/chat/abc123',
                shareVisibility: 'private',
                profileMenuOpen: false,
                theme: 'light',
                activeChatMenu: null,
                mobileSidebarControls: window.innerWidth < 1024,
                
                // Fonctions exposées
                addFileFromComputer,
                addRepository,
                addSpace,
                removeFile,
                clearAllFiles,
                adjustTextareaHeight,
                estimateTokens,
                sendMessage,
                handleDragOver,
                handleContainerDragLeave,
                handleDragLeave,
                handleDrop,
                toggleMessageExpand,
                copyMessage,
                startNewChat,
                updateChatMenuPosition,
                renameChat,
                pinChat,
                deleteChat,
                convertMarkdown,
                copyShareUrl,
                clearAllHistory,
                handleResize
            }));
        });
        
        // Ajuster la hauteur initiale
        window.addEventListener('load', () => {
            adjustTextareaHeight();
            
            // Ajouter les écouteurs d'événements pour le drag-and-drop
            const chatInputContainer = document.getElementById('chatInputContainer');
            if (chatInputContainer) {
                chatInputContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    handleDragOver(e);
                });
                
                chatInputContainer.addEventListener('dragleave', (e) => {
                    handleContainerDragLeave(e);
                });
                
                chatInputContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    handleDrop(e);
                });
            }
            
            // Permettre d'envoyer avec Ctrl+Entrée ou Cmd+Entrée
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            // Initialiser la détection mobile
            handleResize();
        });
    </script>
</body>
</html>
