<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mailix | Profil Utilisateur - Pro</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/7Gn3toV.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
<style>
    /* Configuration de la police Inter */
    body { font-family: 'Inter', sans-serif; }
    
    /* Définition des variables de thème (Ajoutées pour le style) */
    :root {
        /* Couleurs de base (exemple - ajustez si nécessaire) */
        --page-var: #f8fafc; /* light - slate-50 */
        --color-var: #0f172a; /* light - slate-900 */
        --secondary-var: #64748b; /* light - slate-500 */
        --card-var: #ffffff; /* light - white */
        --sidebar-var: #e2e8f0; /* light - slate-200 */
        --sidebar-active-var: #cbd5e1; /* light - slate-300 */
        --input-var: #f1f5f9; /* light - slate-100 */
        --primary-color-var: #4f46e5; /* indigo-600 */
        --primary-hover-var: #4338ca; /* indigo-700 */
        --error-var: #fef2f2; /* red-50 */
        --success-var: #f0fdf4; /* green-50 */
        --warning-var: #fcd34d; /* amber-400 */
    }

    .dark {
        --page-var: #18181b; /* dark - zinc-900 (Gris très foncé pour l'arrière-plan de la page) */
        --color-var: #f4f4f5; /* dark - zinc-100 (Texte clair) */
        --secondary-var: #a1a1aa; /* dark - zinc-400 (Texte secondaire) */
        --card-var: #27272a; /* dark - zinc-800 (Gris foncé pour les cartes et la sidebar) */
        --sidebar-var: #27272a; /* dark - zinc-800 */
        --sidebar-active-var: #3f3f46; /* dark - zinc-700 (Gris un peu plus clair pour l'actif) */
        --input-var: #18181b; /* dark - zinc-900 (Fond de champ de saisie) */
        --primary-color-var: #6366f1; /* indigo-500 (Couleur primaire inchangée) */
        --primary-hover-var: #4f46e5; /* indigo-600 */
        --error-var: #450a0a; /* red-950 */
        --success-var: #052e16; /* green-950 */
        --warning-var: #b45309; /* amber-800 */
    }

    /* Transition pour un effet doux des couleurs */
    .transition-colors-theme { transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
    
    /* Style et positionnement du bouton de Thème */
    .theme-switch {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 24px;
        transition: color 0.2s;
        position: fixed; /* Reste fixe même si le reste défile */
        top: 1rem;
        right: 1rem;
        z-index: 50; /* Doit être au-dessus du reste */
    }

    /* Style pour la sidebar responsive */
    .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 40;
        transform: translateX(-100%);
    }
    
    /* Styles pour le mode desktop/large screen */
    @media (min-width: 1024px) {
        .sidebar {
            transform: translateX(0);
        }
        .main-content {
            margin-left: 16rem; /* 64px width */
        }
    }
    
    /* Styles pour le mode mobile/tablet */
    @media (max-width: 1023px) {
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .sidebar.open {
            transform: translateX(0);
        }
    }
    
    /* Ajout des styles pour les variables CSS dans Tailwind */
    .bg-page-var { background-color: var(--page-var); }
    .text-color-var { color: var(--color-var); }
    .text-secondary-var { color: var(--secondary-var); }
    .bg-card-var { background-color: var(--card-var); }
    .bg-sidebar-var { background-color: var(--sidebar-var); }
    .border-sidebar-var { border-color: var(--sidebar-var); }
    .bg-sidebar-active-var { background-color: var(--sidebar-active-var); }
    .bg-input-var { background-color: var(--input-var); }
    .border-input-var { border-color: var(--input-var); }
    .text-primary-color-var { color: var(--primary-color-var); }
    .focus\:ring-primary-color-var:focus { --tw-ring-color: var(--primary-color-var); }
    .focus\:border-primary-color-var:focus { border-color: var(--primary-color-var); }
    .bg-primary-color-var { background-color: var(--primary-color-var); }
    .hover\:bg-primary-hover-var:hover { background-color: var(--primary-hover-var); }
    .hover\:bg-sidebar-active-var:hover { background-color: var(--sidebar-active-var); }
    .hover\:bg-sidebar-active-var\/80:hover { background-color: color-mix(in srgb, var(--sidebar-active-var) 80%, transparent); }
    
    /* Correction pour les messages flash pour utiliser les variables */
    .bg-red-900\/20 { background-color: color-mix(in srgb, var(--error-var) 20%, transparent); } /* Approximation des couleurs spécifiques */
    .text-red-500 { color: #ef4444; } /* Laissez le rouge spécifique pour les erreurs */
    .border-red-900 { border-color: #7f1d1d; } /* Laissez le rouge spécifique pour les erreurs */
    .bg-green-900\/20 { background-color: color-mix(in srgb, var(--success-var) 20%, transparent); } /* Approximation des couleurs spécifiques */
    .text-green-500 { color: #22c55e; } /* Laissez le vert spécifique pour le succès */
    .border-green-900 { border-color: #064e3b; } /* Laissez le vert spécifique pour le succès */
    .hover\:text-link-hover-var:hover { color: var(--secondary-var); } /* Ajout d'une pseudo-variable pour le hover de l'icône de thème (simple fallback) */
    
</style>
</head>

<body class="bg-page-var text-color-var min-h-screen transition-colors-theme">
    
    <button id="theme-switch" class="theme-switch text-color-var hover:text-link-hover-var transition-colors-theme">
        <span class="material-symbols-rounded">dark_mode</span>
    </button>
    
    <aside id="sidebar" class="sidebar w-64 bg-sidebar-var border-r border-sidebar-var p-6 lg:block transition-colors-theme">
        <div class="flex items-center mb-10">
            <img src="https://i.imgur.com/7Gn3toV.png" alt="Nexus Pro Logo" class="h-8">
            <span class="text-xl font-bold text-color-var ml-2 transition-colors-theme">Mailix</span>
        </div>
        
        <nav class="space-y-3">
            <a href="dashboard.html" class="flex items-center p-3 text-secondary-var hover:text-color-var hover:bg-sidebar-active-var rounded-lg transition duration-150 transition-colors-theme">
                <span class="material-symbols-rounded">dashboard</span>
                <span class="ml-3">Dashboard</span>
            </a>
            <a href="api_key.html" class="flex items-center p-3 text-secondary-var hover:text-color-var hover:bg-sidebar-active-var rounded-lg transition duration-150 transition-colors-theme">
                <span class="material-symbols-rounded">key</span>
                <span class="ml-3">Clés API</span>
            </a>
            <a href="profile.html" class="flex items-center p-3 bg-sidebar-active-var text-color-var rounded-lg transition duration-150 transition-colors-theme">
                <span class="material-symbols-rounded">person</span>
                <span class="ml-3">Profil</span>
            </a>

                <a href="tarifs.html" class="flex items-center p-3 text-secondary-var hover:text-color-var hover:bg-sidebar-active-var rounded-lg transition duration-150 transition-colors-theme">
                <span class="material-symbols-rounded">payments</span>
                <span class="ml-3">Tarifs</span>
            </a>
            <a href="statut.html" class="flex items-center p-3 text-secondary-var hover:text-color-var hover:bg-sidebar-active-var rounded-lg transition duration-150 transition-colors-theme">
                <span class="material-symbols-rounded">monitor_heart</span>
                <span class="ml-3">Statut de l'API</span>
            </a>
            <a href="deconnexion.html" id="logout-button-sidebar" class="flex items-center p-3 text-red-500 hover:text-red-400 hover:bg-sidebar-active-var rounded-lg transition duration-150 transition-colors-theme">
                <span class="material-symbols-rounded">logout</span>
                <span class="ml-3">Déconnexion</span>
            </a>
        </nav>
        
        <div class="absolute bottom-6 w-52 text-xs text-secondary-var transition-colors-theme">
            <p>Connecté en tant que: <span id="sidebar-email" class="font-semibold text-color-var transition-colors-theme">Chargement...</span></p>
            <p>Plan: <span id="sidebar-plan" class="font-semibold text-color-var transition-colors-theme">GRATUIT</span></p>
        </div>
        
    </aside>

    <div id="main-content" class="main-content p-8 transition-colors-theme">
        
        <header class="lg:hidden flex justify-between items-center mb-8">
            <div class="flex items-center">
                 <img src="https://i.imgur.com/7Gn3toV.png" alt="Nexus Pro Logo" class="h-8">
                <span class="text-xl font-bold text-color-var ml-2 transition-colors-theme">Nexus Pro</span>
            </div>
            <button id="sidebar-toggle" class="p-2 rounded-lg bg-sidebar-active-var hover:bg-sidebar-active-var/80 transition-colors-theme">
                 <span class="material-symbols-rounded text-color-var">menu</span>
            </button>
        </header>

        <h1 class="text-3xl font-bold mb-8 text-color-var transition-colors-theme">Profil Utilisateur et Compte</h1>
        
        <div id="flash-messages-container">
            </div>

        <div class="bg-card-var p-6 rounded-lg shadow-xl border border-sidebar-var transition-colors-theme mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center text-color-var transition-colors-theme">
                <span class="material-symbols-rounded mr-2">info</span>
                Vos Informations de Compte
            </h2>
            <div class="space-y-3 text-secondary-var transition-colors-theme">
                <p><strong>Nom d'utilisateur:</strong> <span id="info-username" class="text-color-var font-medium">N/A</span></p>
                <p><strong>Adresse Email:</strong> <span id="info-email" class="text-color-var font-medium">N/A</span></p>
                <p><strong>Plan d'abonnement:</strong> <span id="info-plan" class="text-color-var font-medium">GRATUIT</span></p>
                <p><strong>Date d'inscription:</strong> <span id="info-registration-date" class="text-color-var font-medium">N/A</span></p>
            </div>
        </div>

        <div class="bg-card-var p-6 rounded-lg shadow-xl border border-sidebar-var transition-colors-theme mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center text-color-var transition-colors-theme">
                <span class="material-symbols-rounded mr-2 text-primary-color-var">edit</span>
                Mettre à Jour le Profil et le Mot de Passe
            </h2>
            <p class="text-secondary-var mb-6 text-sm transition-colors-theme">Modifiez votre nom, votre adresse e-mail ou votre mot de passe. Remplissez uniquement les champs que vous souhaitez mettre à jour (sauf pour les champs Nom et Email).</p>
            
            <form id="profile-update-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-secondary-var mb-2 transition-colors-theme">Nom d'utilisateur</label>
                        <input type="text" id="username" name="username" value="" required 
                               class="w-full bg-input-var text-color-var p-3 rounded-lg border border-input-var focus:outline-none focus:ring-2 focus:ring-primary-color-var focus:border-primary-color-var transition-colors-theme">
                    </div>
                    
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-secondary-var mb-2 transition-colors-theme">Adresse E-mail</label>
                        <input type="email" id="email" name="email" value="" required 
                               class="w-full bg-input-var text-color-var p-3 rounded-lg border border-input-var focus:outline-none focus:ring-2 focus:ring-primary-color-var focus:border-primary-color-var transition-colors-theme">
                    </div>
                </div>

                <div class="border-t border-sidebar-var pt-6 mt-4">
                    <h3 class="text-lg font-semibold mb-4 flex items-center text-color-var transition-colors-theme">
                        <span class="material-symbols-rounded mr-2 text-primary-color-var">lock</span>
                        Changement de Mot de Passe (Optionnel)
                    </h3>
                    <p class="text-secondary-var mb-6 text-sm transition-colors-theme">Remplissez ces champs UNIQUEMENT si vous souhaitez changer votre mot de passe.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="mb-4">
                            <label for="new_password" class="block text-sm font-medium text-secondary-var mb-2 transition-colors-theme">Nouveau Mot de Passe</label>
                            <input type="password" id="new_password" name="new_password" placeholder="Laisser vide pour ne pas changer"
                                   class="w-full bg-input-var text-color-var p-3 rounded-lg border border-input-var focus:outline-none focus:ring-2 focus:ring-primary-color-var focus:border-primary-color-var transition-colors-theme">
                        </div>
                        
                        <div class="mb-4">
                            <label for="confirm_password" class="block text-sm font-medium text-secondary-var mb-2 transition-colors-theme">Confirmer le Nouveau Mot de Passe</label>
                             <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirmer le nouveau mot de passe"
                                   class="w-full bg-input-var text-color-var p-3 rounded-lg border border-input-var focus:outline-none focus:ring-2 focus:ring-primary-color-var focus:border-primary-color-var transition-colors-theme">
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <button type="submit" id="save-changes-button" class="w-full bg-primary-color-var hover:bg-primary-hover-var text-white font-bold py-3 px-4 transition duration-200 flex items-center justify-center btn-square transition-colors-theme">
                        <span class="material-symbols-rounded mr-2">save</span>
                        Sauvegarder les Changements
                    </button>
                </div>
            </form>
        </div>

    </div>
    
    <script>
        // URL de base de l'API backend
        const API_BASE_URL = 'https://ernestmindres-mailix.hf.space';
        
        /**
         * Affiche un message flash dans la zone désignée.
         * @param {string} message - Le contenu du message.
         * @param {string} category - La catégorie (e.g., 'success', 'error', 'warning').
         */
        function displayFlashMessage(message, category) {
            const container = document.getElementById('flash-messages-container');
            if (!container) return;

            // Déterminer les classes en fonction de la catégorie
            let classNames = '';
            if (category === 'error' || category === 'danger' || category === 'warning') {
                classNames = 'bg-red-900/20 text-red-500 border-red-900';
            } else {
                classNames = 'bg-green-900/20 text-green-500 border-green-900';
            }

            const alertDiv = document.createElement('div');
            alertDiv.className = `p-4 mb-4 text-sm rounded-lg border border-transparent ${classNames}`;
            alertDiv.setAttribute('role', 'alert');
            alertDiv.textContent = message;

            // Effacer les messages précédents (facultatif, mais aide à la clarté)
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            // Masquer le message après 5 secondes
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        /**
         * Récupère le jeton d'authentification (doit être implémenté selon votre méthode de gestion de session)
         * Pour l'exemple, on suppose qu'il est dans localStorage ou un cookie.
         * @returns {string | null} Le jeton JWT ou la clé API.
         */
        function getAuthToken() {
            // Remplacer 'user_token' par la clé réelle que vous utilisez
            return localStorage.getItem('user_token'); 
        }

        /**
         * Récupère les informations de l'utilisateur depuis l'API et met à jour l'interface.
         */
        async function fetchUserProfile() {
            const token = getAuthToken();
            if (!token) {
                // Rediriger vers la page de connexion si pas de token
                // window.location.href = 'connexion.html'; 
                console.error("Jeton d'authentification manquant. Impossible de charger le profil.");
                displayFlashMessage("Erreur: Non autorisé. Veuillez vous reconnecter.", 'error');
                return;
            }

            try {
                // Assurez-vous que l'endpoint est correct (exemple: /api/v1/user/profile)
                const response = await fetch(`${API_BASE_URL}/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`, // Utilisation courante
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        // Rediriger ou effacer le token invalide
                        displayFlashMessage("Session expirée. Veuillez vous reconnecter.", 'error');
                        // window.location.href = 'connexion.html'; 
                    } else {
                        const errorData = await response.json();
                        displayFlashMessage(errorData.message || `Erreur: Impossible de charger le profil (${response.status})`, 'error');
                    }
                    return;
                }

                const user = await response.json();

                // 1. Mettre à jour les informations du compte
                document.getElementById('info-username').textContent = user.username || 'N/A';
                document.getElementById('info-email').textContent = user.email || 'N/A';
                document.getElementById('info-plan').textContent = (user.plan ? user.plan.toUpperCase() : 'GRATUIT');
                document.getElementById('info-registration-date').textContent = user.registration_date || 'N/A';

                // 2. Mettre à jour le formulaire
                document.getElementById('username').value = user.username || '';
                document.getElementById('email').value = user.email || '';
                
                // 3. Mettre à jour la sidebar
                document.getElementById('sidebar-email').textContent = user.email || 'N/A';
                document.getElementById('sidebar-plan').textContent = (user.plan ? user.plan.toUpperCase() : 'GRATUIT');


            } catch (error) {
                console.error('Erreur lors de la récupération du profil:', error);
                displayFlashMessage("Erreur de connexion au serveur. Veuillez réessayer plus tard.", 'error');
            }
        }
        
        /**
         * Gère la soumission du formulaire de mise à jour du profil.
         */
        async function handleProfileUpdate(e) {
            e.preventDefault();
            const token = getAuthToken();
            if (!token) {
                displayFlashMessage("Erreur: Non autorisé. Veuillez vous reconnecter.", 'error');
                return;
            }
            
            const form = e.target;
            const newUsername = form.username.value.trim();
            const newEmail = form.email.value.trim();
            const newPassword = form.new_password.value.trim();
            const confirmPassword = form.confirm_password.value.trim();
            
            // Validation de base des mots de passe
            if (newPassword && newPassword !== confirmPassword) {
                displayFlashMessage("Erreur: Les nouveaux mots de passe ne correspondent pas.", 'error');
                return;
            }
            
            // Préparer les données à envoyer
            const updateData = {
                username: newUsername,
                email: newEmail
            };
            
            if (newPassword) {
                updateData.new_password = newPassword;
            }

            // Désactiver le bouton et indiquer le chargement
            const saveButton = document.getElementById('save-changes-button');
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="material-symbols-rounded mr-2">progress_activity</span> Mise à jour...';


            try {
                // Assurez-vous que l'endpoint est correct (exemple: /api/v1/user/update)
                const response = await fetch(`${API_BASE_URL}/profile`, {
                    method: 'PUT', // ou 'POST' selon votre backend
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const responseData = await response.json();

                if (response.ok) {
                    displayFlashMessage(responseData.message || "Profil mis à jour avec succès !", 'success');
                    // Recharger les données du profil pour refléter les changements
                    await fetchUserProfile();
                    // Effacer les champs de mot de passe après succès
                    form.new_password.value = '';
                    form.confirm_password.value = '';
                } else {
                    displayFlashMessage(responseData.message || `Erreur lors de la mise à jour du profil: ${response.status}`, 'error');
                }

            } catch (error) {
                console.error('Erreur lors de la mise à jour du profil:', error);
                displayFlashMessage("Erreur de connexion au serveur. Impossible de mettre à jour le profil.", 'error');
            } finally {
                // Réactiver le bouton
                saveButton.disabled = false;
                saveButton.innerHTML = '<span class="material-symbols-rounded mr-2">save</span> Sauvegarder les Changements';
            }
        }
        
        /**
         * Gère la déconnexion via l'API.
         */
        async function handleLogout(e) {
             e.preventDefault();
             const token = getAuthToken();
             if (!token) {
                 // Si pas de token, on efface quand même localement et on redirige
                 localStorage.removeItem('user_token');
                 window.location.href = 'index.html'; // Redirection vers page d'accueil/connexion statique
                 return;
             }
             
             try {
                 // Endpoint de déconnexion (si votre API a besoin d'un appel pour invalider le token côté serveur)
                 // const response = await fetch(`${API_BASE_URL}/logout`, {
                 //     method: 'POST', 
                 //     headers: { 'Authorization': `Bearer ${token}` }
                 // });
                 
                 // if (response.ok) {
                    localStorage.removeItem('user_token'); // Suppression locale du token
                    window.location.href = 'index.html'; // Redirection
                 // } else {
                 //     const errorData = await response.json();
                 //     displayFlashMessage(errorData.message || "Erreur lors de la déconnexion.", 'error');
                 // }
             } catch (error) {
                 console.error('Erreur lors de la déconnexion:', error);
                 localStorage.removeItem('user_token'); // Sécurité: suppression locale
                 window.location.href = 'index.html'; // Redirection
             }
         }


        // --- LOGIQUE DE L'INTERFACE (Conservée) ---
    
        // Fonction utilitaire pour appliquer le thème
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
            // Mettre à jour l'icône du switch si nécessaire
            const icon = document.querySelector('#theme-switch .material-symbols-rounded');
            if (icon) {
                // S'assurer que l'icône reflète le mode ACTIF
                icon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
            }
        }

        // 1. Initialisation du thème au chargement
        const savedTheme = localStorage.getItem('theme') || 'dark'; 
        applyTheme(savedTheme);

        // 2. Logique du switch de thème
        document.getElementById('theme-switch').addEventListener('click', () => {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        });
        
        // 3. Logique de bascule de la sidebar pour mobile/tablette
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        
        if (sidebarToggle && sidebar) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open'); 
            });
        }

        // 4. Fermeture de la sidebar lors du clic sur un lien (pour mobile)
        if (sidebar) {
            const sidebarLinks = sidebar.querySelectorAll('a');
            if (sidebarLinks) {
                sidebarLinks.forEach(link => {
                    link.addEventListener('click', () => {
                        if (window.innerWidth < 1024) {
                            sidebar.classList.remove('open');
                        }
                    });
                });
            }
        }

        // 5. Attacher les écouteurs d'événements API et charger les données
        document.addEventListener('DOMContentLoaded', () => {
            // Charger les données utilisateur au chargement de la page
            fetchUserProfile(); 
            
            // Attacher le gestionnaire de soumission du formulaire
            const profileForm = document.getElementById('profile-update-form');
            if (profileForm) {
                profileForm.addEventListener('submit', handleProfileUpdate);
            }
            
            // Attacher le gestionnaire de déconnexion
            const logoutButtonSidebar = document.getElementById('logout-button-sidebar');
            if (logoutButtonSidebar) {
                logoutButtonSidebar.addEventListener('click', handleLogout);
            }
        });

    </script>
</body>
</html>